# 人格系统与心智模型

本文解释本扩展的“人格（persona）”与“心智模型（mental model）”数据结构：它们是什么、何时初始化、如何更新与衰减、以及对 AI 决策产生哪些影响。

对应源码：

- 人格生成：`src/ai_persona/persona.js`
- 存储键与默认 traits：`src/ai_persona/lib/constants.js`
- 心智模型结构与衰减：`src/ai_persona/memory.js`
- 本地 AI 初始化：`src/ai_persona/runtime/player_init.js`
- 类型定义（JSDoc）：`src/ai_persona/lib/jsdoc_types.js`

---

## 1) 数据落点：player.storage.slqj_ai

扩展把运行时数据写入 `player.storage[STORAGE_KEY]`，其中 `STORAGE_KEY === "slqj_ai"`（见 `src/ai_persona/lib/constants.js`）。

核心字段（按 `src/ai_persona/lib/jsdoc_types.js`）：

- `persona: Persona|null`
- `memory: SlqjAiMemory`
- `runtime: SlqjAiRuntime`
- `stats?: SlqjAiStats`（用于 UI 与策略）

这些数据只在本局内有效，不会跨局持久化（扩展也没有把它们写回配置/磁盘）。

---

## 2) 人格（persona）是什么？

人格是“整局固定的风格参数”，由以下两部分构成：

- `id`：人格类型
- `traits`：特质数值（影响证据权重、仇恨权重、噪声幅度、伪装回合等）

### 2.1 默认 traits
见 `src/ai_persona/lib/constants.js -> DEFAULT_TRAITS`：

- aggressiveness（激进）：`0.5`
- randomness（随机）：`0`（默认不启用噪声）
- revengeWeight（记仇权重）：`1.0`
- insight（洞察）：`0.5`
- camouflageRounds（伪装回合）：`0`（非伪装人格默认不伪装）

### 2.2 人格类型与权重
见 `src/ai_persona/persona.js -> createPersona()`，按权重随机抽取（会受人格开关配置过滤）：

- `balanced`：45
- `impulsive`：20
- `petty`：20
- `camouflage`：15

并在 `DEFAULT_TRAITS` 基础上覆写部分字段：

- impulsive（冲动）：
  - aggressiveness=0.8
  - randomness=0.12（仅当“评分噪声开关”开启时生效）
  - insight=0.35
- petty（记仇）：
  - aggressiveness=0.6
  - revengeWeight=2.2
  - insight=0.5
- camouflage（伪装）：
  - aggressiveness=0.55
  - insight=0.6
  - camouflageRounds=3

> 人格开关配置键：`slqj_ai_persona_enable_balanced/impulsive/petty/camouflage`（其中 camouflage 默认关闭）。若用户关闭了全部人格开关，系统会兜底回退到 balanced，避免出现“无法生成人格”的情况。

> 备注：`randomness` 并不会自动生效；只有在配置 `slqj_ai_score_noise_enable` 开启且人格为 impulsive 时，才会在选择器评分里引入小噪声（见 `src/ai_persona/selector_patch.js`）。

---

## 3) 心智模型（memory）里记录了什么？

心智模型用于让 AI 拥有“本局内的主观推断与情绪变化”。关键字段：

- `firstImpression`：第一印象（开局生成，后续不变）
- `evidence`：行为证据（身份局中，别人对别人做的单目标行为 → 折算为证据）
- `grudge`：仇恨（本地 AI 受伤后对来源累积）
- `rage` / `rageTowards`：怒气（全局怒气与定向怒气）
- `zhuSignal` / `zhuHelp` / `zhuHarm`：主公阵营线索（更像忠/更像反）
- `habits`：本局固定“习惯”（例如酒的时机偏好）
- `basicTempo`：对他人“基本牌节奏”的推断（例如杀密度倾向）

此外还有 `runtime.turnMemory`（本回合记忆）与 `stats`（过牌/伤害统计），它们在 UI 面板中会展示。

---

## 4) 初始化时机：游戏开始（gameStart/roundStart）

初始化由全局技能 `slqj_ai_init` 完成（见 `src/ai_persona/skills/persona_skills.js`）：

1. 触发点：优先 `gameStart`，兜底 `roundStart`（仅执行一次：`player === game.me` 且未标记 `_initOnceDone`）
2. 行为：
   - `initAllPlayersStats(game)`：为所有玩家初始化 `stats`
   - `initAllAiPlayers(game,_status)`：为每个“本地 AI 玩家”以及自机创建 persona 与 memory
   - 若开启 `slqj_ai_inspect_enable`：为所有角色挂 `slqj_ai_inspect` 标记（可点开面板）

### 4.1 initAllAiPlayers：初始化 persona/memory（包含自机）
见 `src/ai_persona/runtime/player_init.js`：

- 对每个满足 `isLocalAIPlayer(...)` 的玩家初始化，并额外始终包含自机（`game.me`）
- 初始化内容包括：
  - `ensureStorage(p)` 确保存储结构存在
  - 若 `persona` 为空则按“人格开关配置”调用 `createPersona(...)`
  - `initMentalModel(p, game, _status)` 初始化 memory/runtime 并清理脏数据
  - 若本次是“首次生成 persona”，会触发 HookBus 事件：`slqj_ai_persona_init`

### 4.2 `slqj_ai_persona_init` hook（对外扩展点）
当某 AI 玩家首次获得人格时，扩展会 `emit("slqj_ai_persona_init", payload)`，payload 结构：

- `player`：该 AI 玩家
- `persona`：生成的人格对象（可被外部改 traits）
- `storage`：`player.storage.slqj_ai`
- `game`：game 引用

用途示例：
- scripts 插件想“固定某种人格/影响某个 traits”可以在此时修改 `payload.persona.traits`（只影响本局）。

---

## 5) initMentalModel：第一印象与习惯

见 `src/ai_persona/memory.js -> initMentalModel(player, game, _status)`：

### 5.1 第一印象（firstImpression）
仅在首次初始化时生成，对每个其他玩家 pid：

- `firstImpression[pid] = (Math.random() - 0.5) * 0.6`，即 `[-0.3, +0.3]`

它代表“开局无信息时的轻微偏好”，后续不会被衰减或覆盖（除非清理脏数据）。

### 5.2 习惯（habits.jiuSearchSha）
扩展为“酒的时机：先喝酒再找牌”生成本局固定习惯（启发式/保守）：

- impulsive：更偏启发式
- camouflage：更偏保守
- petty：中性略偏启发式
- balanced：对半

这个习惯会被默认策略 hooks 用于分流“先喝酒搏节奏”与“手里没杀不空喝”。

### 5.3 脏数据清理
`initMentalModel` 会把 memory 的多个 map 按当前 `game.players` 清理：

- 若 map 的 key（pid）不再出现在玩家列表中，会删除该 key

目的：避免玩家变化导致 map 无限制增长。

---

## 6) 回合推进：turnsTaken 与全局衰减

全局技能 `slqj_ai_turn` 在每个 `phaseBeginStart` 触发（见 `src/ai_persona/skills/persona_skills.js`）：

- 对“当前回合开始的 event.player（若被追踪）”执行：
  - `incTurnsTaken(event.player)`
  - `decayMentalModel(event.player)`

> 追踪口径用于“模型推进/记录”，由 `isAiPersonaTrackedPlayer(...)` 决定：当前实现中自机始终被追踪（用于面板展示与托管接管的数据连续性）；决策门槛仍由 `isLocalAIPlayer(...)` 控制（自机仅在托管时视为本地 AI）。

### 6.1 turnsTaken 的用途
`runtime.turnsTaken` 用于：

- 伪装型（camouflage）在前若干回合压制对主公敌意（见 `src/ai_persona/attitude_patch.js`）

### 6.2 decayMentalModel：衰减的口径与公式
见 `src/ai_persona/memory.js -> decayMentalModel(player)`：

衰减目标包括：

- `evidence`：证据衰减（避免一次事件永久锁死判断）
- `zhuSignal/zhuHelp/zhuHarm`：主公阵营线索衰减（更像“会遗忘/会重新评估”）
- `grudge`：仇恨衰减（小心眼更慢）
- `basicTempo.sha`：基本牌节奏推断衰减
- `rage/rageTowards`：怒气衰减（按人格类型不同）

关键衰减率（与 traits 相关）：

- evidenceRate = clamp(0.9 + insight*0.06, 0.9, 0.98)
- zhuRate      = clamp(0.9 + insight*0.05, 0.9, 0.98)
- grudgeRate   = clamp(0.88 + revengeWeight*0.03, 0.88, 0.97)
- tempoRate    = clamp(0.9 + insight*0.05, 0.9, 0.97)

怒气衰减率（persona 相关）：

- 默认：rageRate=0.88, rageTowardsRate=0.92
- impulsive：rageRate=0.9,  rageTowardsRate=0.93
- petty：    rageRate=0.89, rageTowardsRate=0.95
- camouflage：rageRate=0.86, rageTowardsRate=0.9

调参入口：

- `src/ai_persona/memory.js` 顶部常量 `RAGE_DECAY_RATES`
- `src/ai_persona/events/rage_events.js` 顶部常量 `RAGE_CALM_PER_HEAL`（被加血后冷静幅度）

数值收敛规则（常见）：

- evidence/grudge/zhuSignal 等绝对值很小会被归零（避免浮点残留）
- rage/rageTowards 被 clamp 到 `[0,20]`

---

## 7) 心智模型的“写入 API”（函数级）

`src/ai_persona/memory.js` 提供若干基础写入函数（供事件层调用）：

- `addEvidence(observer, actor, amount)`：写入 `observer.memory.evidence[actorPid]`
- `addGrudge(victim, source, amount)`：写入 `victim.memory.grudge[sourcePid]`
- `addRage(player, amount)`：写入 `player.memory.rage`
- `addRageTowards(player, target, amount)`：写入 `player.memory.rageTowards[targetPid]`
- `addZhuSignal(observer, actor, amount)`：写入 `observer.memory.zhuSignal/zhuHelp/zhuHarm`

这些函数本身不判断模式/触发条件；触发条件由事件层/全局技能层负责（详见后续文档）。
