# 身临其境的AI：扩展总览

本文用于把“身临其境的AI”扩展做的事情拆解成可理解的模块，并给出玩家与开发者两种视角的阅读入口。  
**SSOT（唯一真实来源）**：以下结论以本扩展代码为准（主要入口为 `extension.js` 与 `src/ai_persona/`）。

---

## 1) 玩家视角：这个扩展带来了什么？

### 1.1 人格/心智模型（仅本地 AI）
开局为每个“本地 AI 玩家”随机生成一种人格，并维护一套“心智模型”数据：

- **人格类型（开局随机，整局固定）**：均衡 / 冲动 / 记仇 / 伪装
- **特质参数（面板可见）**：激进、随机、记仇权重、洞察、伪装回合
- **心智模型（面板可见）**：对他人的证据、仇恨、怒气、主公阵营线索、回合记忆等

这些数据只影响 AI 的决策倾向，不会保存到下局（不持久化）。

### 1.2 AI 面板（AI 标记）
可在角色头像旁显示 `AI` 标记，点击查看：

- 本人/他人的人格与特质
- 本局对他人的“态度/证据/仇恨/怒气”
- 身份局的“猜测身份”与原因
- 过牌/造成伤害等统计
- 本回合记忆（谁对谁造成了扣血/加血/弃牌/摸牌）

### 1.3 身份局：独立身份猜测（不读引擎真实身份）
在身份局（`get.mode()==="identity"`）中：

- 扩展会把“单目标行为”折算为 **证据（evidence）**，用来推断谁更像友/敌
- 额外维护 **主公阵营线索（zhuSignal）**：对主公造成伤害/治疗、对主公出杀倾向等
- 最终提供 **猜测身份**（忠/反/内/未知）及其原因（可在面板查看）

> 重要：扩展不读取暗牌与“真实身份”来决定“谁是谁”（仅用公开事件与引擎评分口径）；但为了做一些保守门禁，少量地方会读取“真实身份字段”做布尔判断（例如“忠臣是否已全部阵亡”），详见对应机制文档。

### 1.4 决策行为更“像人”：反全知与噪声
- **反全知（盲选随机化）**：当 AI 在“看不见对方手牌”的场景需要从按钮里选牌时，不再按真实牌面最优解，而改为随机挑选（只影响不可见手牌的按钮）。
- **评分噪声（仅冲动型）**：冲动型人格在选牌/选目标/选按钮时会对正收益候选加入少量随机扰动，避免完全“脚本最优”。

### 1.5 scripts 插件系统（可开关/可排序）
扩展支持加载扩展目录下 `scripts/` 的脚本插件：

- 可整体开关（默认开启）
- 可在“scripts 插件管理”里逐个启用/禁用、调整加载顺序
- 每个脚本可通过 HookBus 注入规则、接管个别武将 AI、做团队配合等

本仓库自带多个脚本（热门选将偏置、铁索队友配合、裴秀/武诸葛/界沮授 AI 接管或加强等）。

---

## 2) 开发者视角：扩展的模块与链路

### 2.1 入口与安装链路
扩展入口在 `extension.js`，核心安装发生在 `precontent(config)`：

1. 安装人格系统：`src/ai_persona/index.js -> installPersonaSystem(...)`
2. 安装投掷表情事件：`src/ai_persona/emotion_throw_event.js -> installEmotionThrowEvent(...)`
3. 加载 scripts 插件：`src/scripts_loader.js -> loadExtensionScripts(...)`
4. scripts 管理 UI：`src/scripts_manager_modal.js -> openScriptsPluginManagerModal(...)`（由配置按钮触发）

关键限制：
- 若 `_status.connectMode===true`（联机连接模式），人格系统/补丁/事件等会整体跳过。

### 2.2 扩展对外“根对象”
扩展把运行时能力挂到 `game` 上，形成两个关键入口：

- `game.__slqjAiPersona`：扩展内部根对象（cfg、hooks、工具函数、调试数据、脚本加载结果等）
- `game.slqjAiHooks`：对外 HookBus（与 `__slqjAiPersona.hooks` 同一实例，供 scripts/外部扩展订阅）

在 `installPersonaSystem` 中会确保二者存在并指向同一 HookBus：

- 若外部已提前注入 `game.slqjAiHooks`，扩展会复用它；
- 否则扩展创建新的 HookBus（见 `src/ai_persona/lib/hook_bus.js`）。

### 2.3 三类“改动点”
本扩展对引擎行为的影响主要分为三类：

1. **全局技能（global skill）注入**：`src/ai_persona/skills/persona_skills.js`
   - 用于：开局初始化、统计、回合记忆、怒气系统、身份局证据记录、软暴露等
2. **函数补丁（patch）**
   - `get.attitude(from,to)` 包装：`src/ai_persona/attitude_patch.js`
   - `ai.basic.chooseCard/chooseTarget/chooseButton` 包装：`src/ai_persona/selector_patch.js`
3. **HookBus 策略层**
   - 扩展内部默认策略：`src/ai_persona/strategies/default_score_hooks.js`（订阅 `slqj_ai_score`）
   - scripts 插件策略：`scripts/*.js`（同样通过 HookBus 注入）

### 2.4 模块目录速查

| 模块 | 主要文件/目录 | 作用 |
|---|---|---|
| 扩展入口/配置 | `extension.js` `info.json` | 安装与 UI 配置项 |
| 人格与心智模型 | `src/ai_persona/persona.js` `src/ai_persona/memory.js` | 生成人格、维护 evidence/grudge/rage 等 |
| 身份猜测 | `src/ai_persona/guess_identity.js` | guessIdentityFor/Consensus 与可解释原因 |
| 身份局证据事件 | `src/ai_persona/events/identity_events.js` | 用牌/技能/拆顺/无懈链 → evidence/zhuSignal |
| 怒气事件 | `src/ai_persona/events/rage_events.js` | 受伤/拆顺/回血 → rage/rageTowards |
| 回合记忆 | `src/ai_persona/events/turn_memory_events.js` | 本回合扣血/加血/弃牌/摸牌记录 |
| 基本牌节奏推断 | `src/ai_persona/events/basic_tempo_events.js` | “杀出得早→杀密度更高” |
| 选择器补丁 | `src/ai_persona/selector_patch.js` | 包装 AI 评分，支持反全知/噪声/小心眼等 |
| 态度补丁 | `src/ai_persona/attitude_patch.js` | identity 未明置时引入“感知态度” |
| UI 面板 | `src/ai_persona/ui/inspect_valuebox_i18n.js` | AI 标记内容（中/英） |
| scripts 加载器 | `src/scripts_loader.js` | 枚举+按顺序 import + 调用入口 |
| scripts 注册表 | `src/scripts_registry.js` | 启用/禁用/顺序持久化 |
| scripts 管理 UI | `src/scripts_manager_modal.js` | 模态对话框管理启用与顺序 |

---

## 3) 下一步阅读建议

- 想知道“有哪些开关、为什么重启生效”：先读 [配置项与生效范围](配置项与生效范围.md)
- 想知道“人格/证据/怒气/回合记忆是什么、怎么变”：读 [人格系统与心智模型](人格系统与心智模型.md) 与 [UI面板、统计与回合记忆](UI面板、统计与回合记忆.md)
- 想知道“身份猜测/证据记录/态度怎么算”：读 [身份猜测、证据与态度系统](身份猜测、证据与态度系统.md)
- 想写脚本插件或接入 Hook：读 [scripts插件系统与内置脚本一览](scripts插件系统与内置脚本一览.md)

